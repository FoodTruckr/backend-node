exports.up = async (knex) => {
  await knex.schema
    .createTable('users', (users) => {
      users.increments('user_id')
      users.string('user_external_id', 10).notNullable().unique().index()
      users.string('username', 255).notNullable().unique()
      users.string('password', 255).notNullable()
      users.string('role', 20).notNullable()
      users.timestamps(false, true)
    })
    .createTable('emails', (emails) => {
      emails.increments('email_id')
      emails.string('email', 255).notNullable()
      emails
        .integer('user_id')
        .unsigned()
        .notNullable()
        .references('user_id')
        .inTable('users')
        .onUpdate('CASCADE')
        .onDelete('RESTRICT')
    })
    .createTable('trucks', (trucks) => {
      trucks.increments('truck_id')
      trucks.string('truck_external_id', 255).notNullable().unique().index()
      trucks.string('truck_name', 255).notNullable().index()
      trucks
        .integer('user_id')
        .unsigned()
        .notNullable()
        .references('user_id')
        .inTable('users')
        .onUpdate('CASCADE')
        .onDelete('CASCADE')
      trucks.decimal('truck_latitude', null, 20)
      trucks.decimal('truck_longitude', null, 20)
      trucks.string('address', 255)
      trucks.string('city', 255)
      trucks.string('state', 2)
      trucks.integer('zip_code', 5)
      trucks.date('arrival_date')
      trucks.time('arrival_time')
      trucks.date('departure_date')
      trucks.time('departure_time')
      trucks.timestamps(false, true)
    })
    .createTable('favorite_trucks', (fave) => {
      fave.increments('favorite_truck_id')
      fave
        .integer('user_id')
        .unsigned()
        .notNullable()
        .references('user_id')
        .inTable('users')
      fave
        .integer('truck_id')
        .unsigned()
        .notNullable()
        .references('truck_id')
        .inTable('trucks')
    })
    .createTable('customer_reviews', (rev) => {
      rev.increments('customer_review_id')
      rev
        .integer('user_id')
        .unsigned()
        .notNullable()
        .references('user_id')
        .inTable('users')
      rev
        .integer('truck_id')
        .unsigned()
        .notNullable()
        .references('truck_id')
        .inTable('trucks')
      rev.decimal('customer_rating', 3, 2).unsigned().notNullable()
      rev.text('customer_review')
    })
    .createTable('cuisine_types', (cuis) => {
      cuis.increments('cuisine_type_id')
      cuis.string('cuisine_type_name', 255).unique().notNullable()
      cuis
        .integer('user_id')
        .unsigned()
        .references('user_id')
        .inTable('users')
        .onUpdate('RESTRICT')
        .onDelete('RESTRICT')
    })
    .createTable('truck_cuisines', (tc) => {
      tc.increments('truck_cuisine_id')
      tc.integer('truck_id')
        .unsigned()
        .notNullable()
        .references('truck_id')
        .inTable('trucks')
      tc.integer('cuisine_type_id')
        .unsigned()
        .notNullable()
        .references('cuisine_type_id')
        .inTable('cuisine_types')
    })
    .createTable('truck_photos', (tp) => {
      tp.increments('truck_photo_id')
      tp.integer('truck_id')
        .unsigned()
        .notNullable()
        .references('truck_id')
        .inTable('trucks')
      tp.text('truck_photo_url').notNullable()
    })
    .createTable('menu_items', (menu) => {
      menu.increments('menu_item_id')
      menu
        .integer('user_id')
        .unsigned()
        .notNullable()
        .references('user_id')
        .inTable('users')
        .onDelete('RESTRICT')
        .onUpdate('CASCADE')
      menu.string('item_name', 255).notNullable()
      menu.text('item_description').notNullable()
      menu.decimal('item_price', null, 2)
    })
    .createTable('menu_item_photos', (mp) => {
      mp.increments('menu_item_photo_id')
      mp.integer('menu_item_id')
        .unsigned()
        .notNullable()
        .references('menu_item_id')
        .inTable('menu_items')
      mp.text('menu_item_photo_url').notNullable()
    })
    .createTable('truck_menu', (tm) => {
      tm.increments('truck_menu_id')
      tm.integer('menu_item_id')
        .unsigned()
        .notNullable()
        .references('menu_item_id')
        .inTable('menu_items')
      tm.integer('truck_id')
        .unsigned()
        .notNullable()
        .references('truck_id')
        .inTable('trucks')
    })
}

exports.down = async (knex) => {
  await knex.schema.dropTableIfExists('truck_menu')
  await knex.schema.dropTableIfExists('menu_item_photos')
  await knex.schema.dropTableIfExists('menu_items')
  await knex.schema.dropTableIfExists('truck_photos')
  await knex.schema.dropTableIfExists('truck_cuisines')
  await knex.schema.dropTableIfExists('cuisine_types')
  await knex.schema.dropTableIfExists('customer_reviews')
  await knex.schema.dropTableIfExists('favorite_trucks')
  await knex.schema.dropTableIfExists('trucks')
  await knex.schema.dropTableIfExists('emails')
  await knex.schema.dropTableIfExists('users')
}
